<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI Face Detection Avatar Generator</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f4f4f4;
    }
    canvas {
      display: block;
      margin-top: 20px;
      max-width: 100%;
      background: white;
    }
    #preview {
      max-width: 300px;
      margin-top: 10px;
      display: block;
    }
    #spinner {
      display: none;
      font-weight: bold;
      color: #555;
    }
  </style>
</head>
<body>
  <h1>AI Face Detection Avatar Generator</h1>
  <input type="file" accept="image/*" id="imageUpload" />
  <img id="preview" alt="Preview" />
  <canvas id="canvas" width="300" height="300"></canvas>
  <p id="status">Select an image to generate your avatar</p>
  <div id="spinner">Loading...</div>

  <!-- TensorFlow + Face Landmarks -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/face-landmarks-detection"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl"></script>

  <!-- THREE.js & GLTF Loader -->
  <script src="https://cdn.jsdelivr.net/npm/three/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three/examples/js/loaders/GLTFLoader.js"></script>

  <script>
    class AvatarApp {
      constructor() {
        this.canvas = document.getElementById('canvas');
        this.ctx = this.canvas.getContext('2d');
        this.preview = document.getElementById('preview');
        this.status = document.getElementById('status');
        this.spinner = document.getElementById('spinner');
        this.scene = new THREE.Scene();
        this.camera = new THREE.PerspectiveCamera(75, 1, 0.1, 1000);
        this.renderer = new THREE.WebGLRenderer({ canvas: this.canvas, alpha: true });
        this.gltfLoader = new THREE.GLTFLoader();
        this.avatar = null;
        this.tfDetector = null;

        this.setupThree();
        this.setupEvents();
        this.loadTF();
      }

      setupThree() {
        this.camera.position.z = 2;
        this.scene.add(new THREE.AmbientLight(0xffffff, 1));
        this.renderer.setSize(300, 300);
      }

      setupEvents() {
        document.getElementById('imageUpload').addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = () => {
            this.preview.src = reader.result;
          };
          reader.readAsDataURL(file);
        });

        this.preview.onload = () => {
          this.detectAndRender();
        };
      }

      async loadTF() {
        this.status.textContent = 'Loading AI model...';
        this.spinner.style.display = 'inline';
        await tf.setBackend('webgl');
        await tf.ready();
        this.tfDetector = await faceLandmarksDetection.createDetector(
          faceLandmarksDetection.SupportedModels.MediaPipeFaceMesh,
          { runtime: 'tfjs', refineLandmarks: true }
        );
        this.spinner.style.display = 'none';
        this.status.textContent = 'Model loaded. Upload a face image.';
      }

      async detectAndRender() {
        if (!this.tfDetector) return;

        this.status.textContent = 'Detecting face...';
        this.spinner.style.display = 'inline';
        try {
          const predictions = await this.tfDetector.estimateFaces(this.preview);
          if (predictions.length === 0) {
            this.status.textContent = 'No face detected.';
            this.spinner.style.display = 'none';
            return;
          }

          const face = predictions[0];
          this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
          this.ctx.drawImage(this.preview, 0, 0, 300, 300);
          this.ctx.strokeStyle = 'red';
          face.keypoints.forEach(pt => {
            this.ctx.beginPath();
            this.ctx.arc(pt.x / (this.preview.naturalWidth / 300), pt.y / (this.preview.naturalHeight / 300), 1.5, 0, 2 * Math.PI);
            this.ctx.stroke();
          });

          this.status.textContent = 'Face detected. Loading avatar...';
          await this.loadAvatar();
        } catch (err) {
          console.error(err);
          this.status.textContent = 'Error during detection.';
        } finally {
          this.spinner.style.display = 'none';
        }
      }

      async loadAvatar() {
        const url = 'https://modelviewer.dev/shared-assets/models/Astronaut.glb';
        try {
          const gltf = await this.gltfLoader.loadAsync(url);
          this.avatar = gltf.scene;
          this.avatar.scale.set(1, 1, 1);

          // Clear previous avatars
          while (this.scene.children.length > 1) {
            this.scene.remove(this.scene.children[1]);
          }

          this.scene.add(this.avatar);
          this.status.textContent = 'Avatar loaded!';
          this.animate();
        } catch (e) {
          console.error(e);
          this.status.textContent = 'Failed to load avatar model.';
        }
      }

      animate() {
        const renderLoop = () => {
          requestAnimationFrame(renderLoop);
          if (this.avatar) this.avatar.rotation.y += 0.01;
          this.renderer.render(this.scene, this.camera);
        };
        renderLoop();
      }
    }

    window.onload = () => {
      new AvatarApp();
    };
  </script>
</body>
</html>
